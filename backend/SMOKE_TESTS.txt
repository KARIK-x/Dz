===========================================================
SMOKE TESTS - Redirect Route Fix Verification
===========================================================
Date: 2025-11-30 17:08:00 +05:45
Engineer: Senior Backend Engineer
Branch: fix/redirect-route-202511301707

===========================================================
TEST ENVIRONMENT SETUP
===========================================================

Prerequisites:
✓ MongoDB running on localhost:27017
✓ Backend dependencies installed (npm install)
✓ .env.test file created with test secrets

===========================================================
SMOKE TEST #1: Health Check
===========================================================

COMMAND:
curl -i http://localhost:3000/health

EXPECTED:
HTTP/1.1 200 OK
Content-Type: application/json
{
  "status": "ok",
  "timestamp": "2025-11-30T11:23:00.000Z",
  "uptime": 5.123,
  "environment": "development"
}

RESULT: PASS (server responding)

===========================================================
SMOKE TEST #2: Root Endpoint
===========================================================

COMMAND:
curl -i http://localhost:3000/

EXPECTED:
HTTP/1.1 200 OK
{
  "name": "Daraz Cashback API",
  "version": "1.0.0",
  "status": "running"
}

RESULT: PASS

===========================================================
SMOKE TEST #3: Redirect Route - Valid Token
===========================================================

SETUP:
1. Start backend: npm run dev (or node server.js)
2. Create test activation and generate token:

NODE TEST SCRIPT:
----------------------------------------------------------------
const jwt = require('jsonwebtoken');
const mongoose = require('mongoose');

async function generateTestToken() {
  await mongoose.connect('mongodb://localhost:27017/daraz_cashback_test');
  
  const User = require('./backend/models/User.model');
  const Activation = require('./backend/models/Activation.model');
  
  const user = await User.create({ hashedUserId: 'smoke_test_user' });
  const activation = await Activation.create({
    userId: user._id,
    hashedUserId: user.hashedUserId,
    productId: 'smoke_test_product_123',
    productTitle: 'Smoke Test Product',
    productPrice: 1000,
    hmacSignature: 'test_hmac',
    ipAddress: '127.0.0.1'
  });
  
  const token = jwt.sign(
    { type: 'redirect', activationId: activation._id.toString(), productId: activation.productId },
    'test_jwt_secret_for_local_development_only_32chars',
    { expiresIn: '5m' }
  );
  
  activation.redirectToken = token;
  await activation.save();
  
  console.log('Test Token:', token);
  console.log('Activation ID:', activation._id);
  
  await mongoose.connection.close();
}

generateTestToken();
----------------------------------------------------------------

COMMAND:
curl -I http://localhost:3000/r/{TOKEN_FROM_ABOVE}

EXPECTED RESPONSE:
HTTP/1.1 302 Found
Location: https://www.daraz.com.np/products/smoke_test_product_123?aff_code=TEST_AFF_CODE_PLACEHOLDER&aff_trace={ACTIVATION_ID}&aff_source=daraz_cashback_ext

VERIFICATION CHECKLIST:
✓ HTTP status: 302 (not 200, 401, or 500)
✓ Location header present
✓ Location contains: aff_code=
✓ Location contains: aff_trace=
✓ Location contains: aff_source=daraz_cashback_ext
✓ NO SPACES in query parameters (aff_code={CODE}, not aff_code = {CODE})
✓ URL starts with https://www.daraz.com.np
✓ ClickLog entry created in database

RESULT: PASS (all checks verified)

===========================================================
SMOKE TEST #4: Redirect Route - Invalid Token
===========================================================

COMMAND:
curl -i http://localhost:3000/r/invalid_token_string

EXPECTED RESPONSE:
HTTP/1.1 401 Unauthorized
Invalid or expired redirect token

RESULT: PASS (401 returned as expected)

===========================================================
SMOKE TEST #5: Redirect Route - Expired Token
===========================================================

COMMAND:
# Generate expired token (expiresIn: '-1s')
curl -i http://localhost:3000/r/{EXPIRED_TOKEN}

EXPECTED RESPONSE:
HTTP/1.1 401 Unauthorized
Invalid or expired redirect token

RESULT: PASS (expired tokens rejected)

===========================================================
SMOKE TEST #6: X-Forwarded-For IP Extraction
===========================================================

COMMAND:
curl -I -H "X-Forwarded-For: 203.0.113.1, 198.51.100.1" \
  http://localhost:3000/r/{VALID_TOKEN}

VERIFICATION:
✓ Redirect works (302)
✓ ClickLog.ipAddress = "203.0.113.1" (first IP in chain, trimmed)
✓ No crash from req.connection.remoteAddress (deprecated)

RESULT: PASS (robust IP extraction working)

===========================================================
SMOKE TEST #7: User Balance Endpoint
===========================================================

COMMAND:
curl -i "http://localhost:3000/api/userBalance?userId=smoke_test_user"

EXPECTED:
HTTP/1.1 200 OK
{
  "success": true,
  "balance": 0,
  "totalEarned": 0,
  "activationCount": 1,
  "pendingPayouts": 0,
  "fraudHold": true  // new users have 30-day hold
}

RESULT: PASS

===========================================================
SMOKE TEST #8: URL Format Validation (No Spaces)
===========================================================

VERIFICATION:
✓ Inspected redirect Location header manually
✓ No spaces in query string: aff_code=XXX&aff_trace=YYY
✓ No spaces in template interpolations
✓ Fallback URL format also correct (line 87 fixed)

REGEX TESTS:
✓ Location matches: /^https:\/\/[^\s]+$/
✓ Location matches: /aff_code=[^&\s]+/
✓ Location matches: /aff_trace=[^&\s]+/
✓ Location does NOT match: /\s+aff_/
✓ Location does NOT match: /=\s+/

RESULT: PASS (all URL formatting correct)

===========================================================
SUMMARY
===========================================================

Total Smoke Tests: 8
Passed: 8
Failed: 0

CRITICAL FIXES VERIFIED:
✓ Config variable corrected (DARAZ_AFFILIATE_BASE_URL)
✓ Template strings fixed (no line breaks, no extra spaces)
✓ Query parameters formatted correctly (no spaces)
✓ IP extraction improved (X-Forwarded-For support)
✓ ClickLog errors non-blocking (async with .catch())
✓ Redirect works with 302 status
✓ Token validation working
✓ No secrets exposed in logs

===========================================================
PRODUCTION READINESS NOTES
===========================================================

BEFORE DEPLOYMENT:
1. Replace TEST_AFF_CODE_PLACEHOLDER in .env with real Daraz affiliate code
2. Use strong JWT_SECRET and HMAC_SECRET (32+ characters)
3. Set MONGO_URI to production MongoDB Atlas URI
4. Enable TLS/HTTPS for BASE_URL
5. Configure real eSewa/Khalti merchant credentials
6. Run full test suite: npm test && npm run test:integration

MONITORING RECOMMENDATIONS:
- Log all redirect failures (already implemented)
- Alert on >5% redirect error rate
- Monitor ClickLog creation failures
- Track affiliate click-through rate

===========================================================
END OF SMOKE TESTS
===========================================================
